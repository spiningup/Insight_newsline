(function(e){"use strict";var t=Array.prototype.indexOf,n=function(e,n){var r=0,i=e.length;if(t&&e.indexOf===t)return e.indexOf(n);for(;r<i;r++)if(e[r]===n)return r;return-1},r=e.Tabletop=function(e){if(!this||!(this instanceof r))return new r(e);typeof e=="string"&&(e={key:e}),this.callback=e.callback,this.wanted=e.wanted||[],this.key=e.key,this.simpleSheet=!!e.simpleSheet,this.parseNumbers=!!e.parseNumbers,this.wait=!!e.wait,this.postProcess=e.postProcess,this.debug=!!e.debug,this.query=e.query||"",this.endpoint=e.endpoint||"https://spreadsheets.google.com",this.singleton=!!e.singleton,this.simple_url=!!e.simple_url,typeof e.proxy!="undefined"&&(this.endpoint=e.proxy,this.simple_url=!0,this.singleton=!0),this.parameterize=e.parameterize||!1,this.singleton&&(typeof r.singleton!="undefined"&&this.log("WARNING! Tabletop singleton already defined"),r.singleton=this),/key=/.test(this.key)&&(this.log("You passed a key as a URL! Attempting to parse."),this.key=this.key.match("key=(.*?)&")[1]);if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key),this.models={},this.model_names=[],this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=json-in-script",this.wait||this.fetch()};r.callbacks={},r.init=function(e){return new r(e)},r.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")},r.prototype={fetch:function(e){typeof e!="undefined"&&(this.callback=e),this.injectScript(this.base_json_path,this.loadSheets)},injectScript:function(e,t){var n=document.createElement("script"),i;if(this.singleton)t===this.loadSheets?i="Tabletop.singleton.loadSheets":t===this.loadSheet&&(i="Tabletop.singleton.loadSheet");else{var s=this;i="tt"+ +(new Date)+Math.floor(Math.random()*1e5),r.callbacks[i]=function(){var e=Array.prototype.slice.call(arguments,0);t.apply(s,e),n.parentNode.removeChild(n),delete r.callbacks[i]},i="Tabletop.callbacks."+i}var o=e+"&callback="+i;this.simple_url?e.indexOf("/list/")!==-1?n.src=this.endpoint+"/"+this.key+"-"+e.split("/")[4]:n.src=this.endpoint+"/"+this.key:n.src=this.endpoint+o,this.parameterize&&(n.src=this.parameterize+encodeURIComponent(n.src)),document.getElementsByTagName("script")[0].parentNode.appendChild(n)},isWanted:function(e){return this.wanted.length===0?!0:n(this.wanted,e)!==-1},data:function(){return this.model_names.length===0?undefined:this.simpleSheet?(this.model_names.length>1&&this.debug&&this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.model_names[0]].all()):this.models},addWanted:function(e){n(this.wanted,e)===-1&&this.wanted.push(e)},loadSheets:function(e){var t,n,r=[];for(t=0,n=e.feed.entry.length;t<n;t++)if(this.isWanted(e.feed.entry[t].content.$t)){var i=e.feed.entry[t].link[3].href.substr(e.feed.entry[t].link[3].href.length-3,3),s="/feeds/list/"+this.key+"/"+i+"/public/values?alt=json-in-script&sq="+this.query;r.push(s)}this.sheetsToLoad=r.length;for(t=0,n=r.length;t<n;t++)this.injectScript(r[t],this.loadSheet)},sheets:function(e){if(typeof e=="undefined")return this.models;if(typeof this.models[e]=="undefined")return;return this.models[e]},loadSheet:function(e){var t=new r.Model({data:e,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[t.name]=t,n(this.model_names,t.name)===-1&&this.model_names.push(t.name),this.sheetsToLoad--,this.sheetsToLoad===0&&this.doCallback()},doCallback:function(){this.sheetsToLoad===0&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(e){this.debug&&typeof console!="undefined"&&typeof console.log!="undefined"&&Function.prototype.apply.apply(console.log,[console,arguments])}},r.Model=function(e){var t,n,r,i;this.column_names=[],this.name=e.data.feed.title.$t,this.elements=[],this.raw=e.data;if(typeof e.data.feed.entry=="undefined"){e.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),this.elements=[];return}for(var s in e.data.feed.entry[0])/^gsx/.test(s)&&this.column_names.push(s.replace("gsx$",""));for(t=0,r=e.data.feed.entry.length;t<r;t++){var o=e.data.feed.entry[t],u={};for(var n=0,i=this.column_names.length;n<i;n++){var a=o["gsx$"+this.column_names[n]];typeof a!="undefined"?e.parseNumbers&&a.$t!==""&&!isNaN(a.$t)?u[this.column_names[n]]=+a.$t:u[this.column_names[n]]=a.$t:u[this.column_names[n]]=""}u.rowNumber===undefined&&(u.rowNumber=t+1),e.postProcess&&e.postProcess(u),this.elements.push(u)}},r.Model.prototype={all:function(){return this.elements},toArray:function(){var e=[],t,n,r,i;for(t=0,r=this.elements.length;t<r;t++){var s=[];for(n=0,i=this.column_names.length;n<i;n++)s.push(this.elements[t][this.column_names[n]]);e.push(s)}return e}}})(this);